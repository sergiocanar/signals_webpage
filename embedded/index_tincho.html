<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" href="./images/favicon.ico">
    <style>
/* General */
html, body {
    height: 100%;  /* Ensure full height of the viewport */
    margin: 0;
    padding: 0;
    background-color: #ffffff;
    font-family: Arial, sans-serif;
    text-align: center; /* Center all text horizontally */
    display: flex;
    flex-direction: column;
    font-size: 20px;
}

.container {
    flex: 1; /* This allows the container to grow and fill the available space */
    padding: 100px; /* Adjust this to match the footer height */
}

/* Header */
header {
    background-color: #28262C;
    color: #F9F5FF;
    padding: 20px;
}

/* Sections */
section {
    padding: 20px;
    margin: 20px;
    background-color: #F9F5FF;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

h1 {
    margin: 50px;
    font-size: 4em;
    color: #28262C;
}

h3 {
    
    font-size: 30px;
    
}


h2 {
    margin: 0;
    font-size: 1.5em;
    color: #28262C;
}

h4 {
    text-align: left;
    font-size: 25px;
}


p {
    text-align: justify;
    font-size: 25px;

}


/* Button */
button {
    padding: 10px 20px;
    font-size: 1em;
    color: #f7f7f7;
    background-color: #316bd6;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 20px;
    margin-bottom:5px;
}


button:hover {
    background-color: #2da0d7;
}

/* List */
ul {
    list-style-type: none;
    padding: 0;
}

li {
    margin: 10px 0;
    font-size: 16px;
}

ol {
        list-style-type: decimal; /* Asegura que la lista sea numérica */
        padding-left: 20px; /* Espacio a la izquierda para la numeración */
        text-align: left; /* Alinea el texto a la izquierda */
        margin: 0; /* Elimina el margen por defecto */
        
    }

ol li {
    margin-bottom: 10px; /* Añade un pequeño espacio entre los elementos */
    text-decoration: underline;
    font-size: 25px; 
}

li p {
    margin: 0; /* Elimina márgenes en los párrafos dentro de los elementos de lista */
}


/* Footer */
#footer {
    position: relative; /* Keep footer fixed at the bottom */
    width: 100%; /* Full width */
    background-color: #28262C;
    color: white;
    text-align: center;
    font-size: 5px;
}

a {
    color: #d7db1c;
    font-size: 10px;
}

a:link, a:visited {
    color: #d4c2fc;
    text-decoration: none;
}

#ecg-container {
    width: 100%; 
    height: 500px;
    margin-bottom: 5%;
}

#tachogran-container {
    width: 100%;
    height: 500px;
    margin-bottom: 100%;    
    padding: 100px;
}

#freq {
    width: 10%;
    margin: auto;
}

/* Popup Style */
.popup {
    display: none; /* Hidden by default */
    position: fixed; /* Stay in place */
    z-index: 1000; /* Sit on top */
    left: 0;
    top: 0;
    width: 100%; /* Full width */
    height: 100%; /* Full height */
    overflow: auto; /* Enable scroll if needed */
    background-color: rgb(0,0,0); /* Fallback color */
    background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

.popup-content {
    background-color: #ffffff;
    margin: 15% auto; /* 15% from the top and centered */
    padding: 20px;
    border: 1px solid #888;
    width: 80%; /* Could be more or less, depending on screen size */
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}
</style>
    <!-- <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous"> -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
</head>

<body>
    <figure style="position: relative; top: 20px; display: flex; flex-direction: column; align-items: center; margin: 0 auto;">
        <img class="img-fluid" src="./images/3_copy.png" alt="Descripción de la imagen" style="width: 50%; margin-bottom: 3%;">
    </figure>
    
    
            <figure style="position: absolute; top: 20px; right:60%">
                <img class="img-fluid" src="./images/ibio_n.png" alt="Universidad de los Andes" style="width: 70%;">
                
            </figure>
            
            
            <button id="info-button" 
            style="position: absolute; right: 100px; top: 20px; padding: 20px 40px; font-size: 25px; border-radius: 5px; background-color: #316bd6; color: white; border: none; cursor: pointer;" 
                onmouseover="this.style.backgroundColor='#2da0d7';" 
                onmouseout="this.style.backgroundColor='#316bd6';" 
                onclick="showPopup()">
            ¡Descubre más sobre CardioHub!<br>
            <span style="display: block; text-indent: 20px;">Monitoreo inteligente para atletas en evolución.</span>
        </button>
        
            
        </div>
        <div class="row">
            <div class="col-6">
                <div style="margin-bottom: 20px;">
                    <label for="freq" style="font-size: 30px;">Frequency: </label>
                    <input type="range" id="freq" min="0" max="100" value="10" step="5">
                    <span id="freq-display" style="font-size: 30px;">10 Hz</span>
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="start-point" style="font-size: 30px;">Explore ECG: </label>
                    <input type="range" id="start-point" min="0" value="0" step="1">
                    <span id="start-point-display" style="font-size: 30px;">0</span>
                </div>
                <div style="margin-bottom: 20px;">
                    <label for="window-size" style="font-size: 30px;">Window size (number of data): </label>
                    <input type="range" id="window-size" min="100" value="1" step="1">
                    <span id="window-size-display" style="font-size: 30px;">100</span>
                </div>
            </div>
        </div>
        
            <div class="col-6">
                <div id="bpm-container" style="text-align: center;">
                    <h3 id="bpm-result"></h3>
                    <h3 id="alert"></h3>
                    <button id="more-info-button" onclick="showMoreInfo()" style="display:none; margin: auto; font-size: 25px;">Obtener más información sobre mi estado</button>
                    <div style="height: 50px; text-align: center;"></div>
                </div>
            </div>
        </div>
        <div id="popup" class="popup">
            <div class="popup-content">
                <span class="close" onclick="closePopup()">&times;</span>
                <h2>CardioHub: Monitoreo inteligente para atletas en evolución.</h2>
                <figure style="position: relative; align-items: center; margin: 0 auto;">
                    <img class="img-fluid" src="./images/3_copy.png" alt="Descripción de la imagen" style="width: 10%; ">
                </figure>
                <h4>Sobre las arritmias y la problemática actual: </h4>
                <p>La práctica deportiva de alto rendimiento se ha asociado en los últimos años con cardiomiopatías, arritmias ventriculares y enfermedades coronarias, subrayando la importancia de una vigilancia constante tanto durante el ejercicio como en la fase de recuperación [1]. Factores como la deshidratación, alteraciones electrolíticas, estrés fisiológico y fatiga muscular incrementan la susceptibilidad de los atletas a problemas cardíacos, elevando el riesgo de muerte súbita cardíaca (MSC), particularmente en aquellos con afecciones subyacentes no diagnosticadas, como la cardiomiopatía hipertrófica [2]. A esto se le suma que la incidencia de MSC es más alta durante o inmediatamente después del ejercicio, lo que refuerza la necesidad de soluciones tecnológicas para monitorear en tiempo real la actividad cardíaca, alertando a los deportistas y entrenadores sobre posibles anormalidades que pongan en peligro la vida [3]. Dentro de las opciones existentes para llevar a cabo un monitoreo constante, el uso de electrocardiogramas (ECG) resulta esencial, ya que permite medir la actividad eléctrica del corazón y detectar arritmias y anomalías en la conducción [4].
                    El proyecto ha sido impulsado por varios incidentes notables en el ámbito deportivo que han subrayado la necesidad urgente de mejorar las herramientas de monitoreo cardíaco para los atletas. Uno de los casos más recientes y reconocidos es el del futbolista Sergio Agüero, quien en 2021 sufrió una arritmia durante un partido, lo que lo obligó a retirarse del fútbol profesional. Este caso no solo demostró las posibles consecuencias de una arritmia no diagnosticada a tiempo, sino que también reveló la necesidad de un monitoreo más riguroso durante la actividad deportiva. Otro ejemplo es el del jugador de fútbol uruguayo Juan Izquierdo, quien falleció a causa de un paro cardiorrespiratorio relacionado con una arritmia mientras entrenaba [5]. Las circunstancias y problemática del monitoreo cardíaco se extienden a otras disciplinas del deporte, ejemplo de esto es el caso del triatleta sudafricano Richard Murray, quien fue diagnosticado con fibrilación auricular en 2021, lo que limitó su rendimiento en esta disciplina. Desde entonces, ha tenido que adaptar su entrenamiento y estilo de vida para gestionar la afección [6].
                    </p>
                <figure style="position: relative; align-items: center; margin: 0 auto;">
                    <img class="img-fluid" src="./images/Imagen_inv.png" alt="Descripción de la imagen" style="width: 70%; ">
                </figure>
                <h4>Datos estadísticos sobre las arritmias, un problema común en atletas de alto rendimiento: </h4>
                <p>En cuanto a los datos estadísticos, la arritmia cardiaca tiene una prevalencia global del 1.5% al 5%, siendo la fibrilación auricular (FA) su forma más común [7]. En Colombia, se estima que entre el año 2013 y 2017, 87 de cada 100,000 habitantes padecían de FA, donde este valor incrementaba a 150 en regiones centrales del país [8]. En lo que respecta a los deportistas, se estima que 1 de cada 59,452 deportistas sufre un paro cardiaco asociado a una arritmia cardiaca, lo que representa 1.7 casos por cada 100,000 atletas [9]. Las estadísticas epidemiológicas también han revelado el alcance del problema. Investigaciones recientes han mostrado que el 12.9% de los corredores de maratón experimentaron arritmias ventriculares durante la carrera [10]. Dichos escenarios muestran el riesgo a la salud y la vida al que pueden llegar a estar expuestos los atletas, además de generar dudas sobre la capacidad actual de los dispositivos de monitoreo para detectar arritmias de manera oportuna durante el ejercicio intenso.
                    </p>
                <h4>Principales causas que contribuyen al desarrollo de la fisiopatología: </h4>
                <ol>
                    <li>Suplementos deportivos</li>
                    <p>El uso de suplementos deportivos, especialmente esteroides anaeróbicos, está asociado con un mayor riesgo de FA en atletas jóvenes. Estos productos pueden alterar los mecanismos cardíacos normales, predisponiendo al desarrollo de arritmias [11] </p>
                    <li>Ectopia auricular</li>
                    <p>La FA en deportistas también puede ser provocada por descargas ectópicas focales en las venas pulmonares. Estas descargas son el resultado de un aumento en la actividad simpática debido al ejercicio intenso, lo que puede alterar el ritmo cardíaco normal [11]</p>
                    <li>Inflamación y fibrosis</li>
                    <p>El ejercicio excesivo y el entrenamiento intenso pueden causar inflamación sistémica crónica, manifestada en niveles elevados de proteína C-reactiva. Este proceso inflamatorio, junto con el desarrollo de fibrosis en el tejido cardíaco, crea un ambiente propicio para la aparición de FA, ya que altera la estructura y función normal del corazón [11]</p>
                    <li>Desequilibrio electrolítico</li>
                    <p>El entrenamiento de alta intensidad puede generar cambios significativos en la dinámica de fluidos del cuerpo, lo que conduce a desequilibrios electrolíticos. Estos desequilibrios, como la deshidratación extrema, pueden alterar la función cardíaca y favorecer el desarrollo de FA en los atletas [11].</p>
                </ol>
                <h4> CardioHub como wereable, su relevancia para el monitoreo de arritmias en atletas: </h4> 
                <p>El uso de un dispositivo wearable como CardioHub para monitorear en tiempo real la actividad eléctrica del corazón, es crucial para prevenir complicaciones graves en los deportistas.  dispositivos permiten la detección temprana de arritmias y proporcionan información precisa sobre el estado cardíaco durante el ejercicio intenso y la recuperación, ayudando a prevenir la muerte súbita cardíaca (MSC). Al proporcionar alertas en tiempo real sobre irregularidades cardíacas, estos wearables permiten a los entrenadores y médicos tomar decisiones rápidas y evitar que las condiciones no diagnosticadas progresen hacia situaciones críticas [12]. Además, el monitoreo continuo ayuda a ajustar las rutinas de entrenamiento de los atletas para optimizar su salud y rendimiento sin comprometer su bienestar cardíaco [13].
                </p>
                <p style="font-size: 20px; text-align: center; font-style: italic; font-weight: 550; color: #316bd6;">CardioHub proporciona una solución innovadora para salvaguardar la salud de los atletas mientras se esfuerzan por alcanzar su máximo rendimiento. La clave está en la prevención, y el monitoreo continuo es la herramienta que garantiza que los corazones de los deportistas sigan latiendo con seguridad y fortaleza.</p>

                <figure style="position: relative; align-items: center; margin: 0 auto;">
                    <img class="img-fluid" src="./images/Imagen4.jpg" alt="Descripción de la imagen" style="width: 30%; ">
                </figure>

                <h4>Referencias</h4>
                <ol>[1] S. Fyyaz y M. Papadakis, “Arrhythmogenesis of Sports: Myth or Reality?” Arrhythm Electrophysiol Rev, vol. 11, e05, abr. de 2022. DOI: 10.15420/aer.2021.68.</ol>
                <ol>[2] P. Rao, D. R. Seshadri y J. J. Hsu, “Current and potential applications of wearables in sports cardiology,” Curr. Treat. Options Cardiovasc. Med., vol. 23, n.o 10, oct. de 2021, Accessed Sep. 10, 2024. direccion: https://doi. ´ org/10.1007/s11936-021-00942-1.</ol>
                <ol>[3] R. Gajda, J. Gajda, M. Czuba, B. Knechtle y W. Drygas, “Sports heart monitors as reliable diagnostic tools for training control and detecting arrhythmias in professional and leisure-time endurance athletes: An expert consensus statement,” Sports Med., oct. de 2023, Accessed Sep. 10, 2024. direccion: https://doi.org/10. ´ 1007/s40279-023-01948-4.</ol>
                <ol>[4] D. G. Grazioli, Arritmia ventricular y fibrosis miocardi- ´ ca en atletas, https : / / secardiologia . es / blog / 8298 - arritmia- ventricular- y- fibrosis- miocardica- en- atletas, Accessed: Aug. 31, 2024.</ol>
                <ol>[5] H. Y. Izquierdo, La arritmia cardiaca sacude al futbol: ´ el enemigo silencioso de los jugadores tras los casos del ‘Kun’ Aguero y Juan Izquierdo ¨ , https://www.eltiempo. com/deportes/futbol-internacional/la-arritmia-cardiacasacude - al - futbol - el - enemigo - silencioso - de - los - jugadores - tras - los - casos - del - kun - aguero - y - juan - izquierdo-3375588, Accessed: Aug. 31, 2024.</ol>
                <ol>[6] H. Heidbuchel, “The athlete’s heart is a proarrhythmic heart, and what that means for clinical decision making,” EP Eur., vol. 20, n.o 9, pags. 1401-1411, dic. de ´ 2017, Accessed Sep. 10, 2024. direccion: https://doi. ´ org/10.1093/europace/eux294.</ol>
                <ol>[7] D. S. Desai y S. Hajouli, “Arrhythmias,” en StatPearls, Consultado: el 10 de septiembre de 2024, Treasure Island (FL): StatPearls Publishing, 2024. direccion: http: ´ //www.ncbi.nlm.nih.gov/books/NBK558923/.</ol> 
                <ol>[8] A. A. Garc ´ ´ıa-Pena et al., “Prevalencia de fibrilaci ˜ on´ auricular en Colombia segun informaci ´ on del Sistema ´ Integral de Informacion de la Protecci ´ on Social (SIS- ´ PRO),” Revista Colombiana de Cardiolog´ıa, vol. 29, n.o 2, pags. 170-176, abr. de 2022. ´ DOI: 10.24875/rccar. m22000139.</ol>
                <ol>[9] M. Rage et al., “Cardiomyopathy and Sudden Cardiac Death Among the Athletes in Developing Countries: Incidence and Their Prevention Strategies,” Cureus, vol. 15, n.o 2, e35612, 2023. DOI: 10 . 7759 / cureus . 35612. </ol>
                <ol>[10] A. E. V. Toaquiza y D. A. A. T. Aguilar, “Arritmias ventriculares y su relacion con la muerte s ´ ubita car- ´ diaca en deportistas,” Ciencia Latina Revista Cient´ıfica Multidisciplinar, vol. 6, n.o 5, nov. de 2022. DOI: 10. 37811/cl rcm.v6i5.3313.</ol>
                <ol>[11] M. K. Turagam, G. C. Flaker, P. Velagapudi, S. Vadali y M. A. Alpert, “Atrial Fibrillation In Athletes: Pathophysiology, Clinical Presentation, Evaluation and Management,” J Atr Fibrillation, vol. 8, n.o 4, pag. 1309, dic. de 2015. ´ DOI: 10.4022/jafib.1309. </ol>
                <ol>[12] A. Pingitore, M. Peruzzi, S. C. Clarich, Z. Palama,` L. Sciarra y E. Cavarretta, “An overview of the electrocardiographic monitoring devices in sports cardiology: Between present and future,” Clin. Cardiol., jun. de 2023, Accessed Sep. 10, 2024. direccion: https://doi. ´ org/10.1002/clc.24073. </ol>
                <ol>[13] F. Halabchi, T. Seif-Barghi y R. Mazaheri, “Sudden cardiac death in young athletes; a literature review and special considerations in asia,” Asian J. Sports Medicine, vol. 2, n.o 1, mar. de 2011, Accessed Sep. 10, 2024. direccion: https://doi.org/10.5812/asjsm.34818</ol>
                

            </div>
        </div>     
        <div class="row">
            <div id="ecg-container"></div>
        </div>
        <div class="row">
            <div id="tachogram-container"></div>
        </div>
    </div>
    
    <footer id="footer" style="text-align: center;">
        <p style="font-size: 18px; text-align: center;">
            Authors: 
            <a href="https://github.com/sergiocanar" style="font-size: 18px;">Sergio Andres Canar Lozano</a> (202020383), 
            <a href="https://github.com/DavidTobonIBIO" style="font-size: 18px;">David Tobon Molina</a> (202123804), 
            <a href="https://github.com/msalcedog" style="font-size: 18px;">Martin Salcedo</a> (202123644), 
            and Wilman Sanchez (202116779)
          </p>
          <p style="font-size: 18px;text-align: center;">
            Source code: 
            <a href="https://github.com/sergiocanar/signals_webpage" style="font-size: 18px;">
              https://github.com/sergiocanar/signals_webpage
            </a>
          </p>          
          
    </footer>
    
    <script>
// Variables globales para almacenar la señal ECG, el tiempo y los intervalos RR
let ecgSignal = [];
let timeArray = [];
let rrIntervals = [];

/**
 * Actualiza la visualización del ECG en la página web.
 * 
 * Esta función realiza las siguientes acciones:
 * 1. Obtiene los valores de los sliders de frecuencia, punto de inicio y tamaño de ventana.
 * 2. Actualiza la visualización de los valores de los sliders en la interfaz de usuario.
 * 3. Llama a la función `updatePlots` para actualizar los gráficos con los nuevos valores.
 * 4. Llama a la función `calculateBPM` para calcular los latidos por minuto.
 * 
 * @function
 */
function updateView() {
    // obtener los valores de los sliders
    let freqVal = parseInt(document.getElementById('freq').value);
    let startPointVal = parseInt(document.getElementById('start-point').value);
    let windowSizeVal = parseInt(document.getElementById('window-size').value);
    // Actualizar la vista de los valores de los sliders
    document.getElementById('freq-display').innerText = freqVal + " Hz";
    document.getElementById('start-point-display').innerText = startPointVal;
    document.getElementById('window-size-display').innerText = windowSizeVal;
    // Actualizar los gráficos
    updatePlots(freqVal, startPointVal, windowSizeVal);  
    // Calcula los latidos por minuto
    calculateBPM();
}

/**
 * Establece los valores máximos de los deslizadores 'start-point' y 'window-size'.
 *
 * @param {number} nData - El valor máximo que se establecerá en los deslizadores.
 */
function setMaxSliderValues(nData) {
    document.getElementById('start-point').max = nData;
    document.getElementById('window-size').max = nData;
}

/**
 * Crea una señal ECG simulada.
 *
 * @param {number} sampleRate - La tasa de muestreo de la señal en Hz (frecuecia).
 * @returns {void}
 *
 * @description
 * Esta función genera una señal ECG simulada y la almacena en el arreglo `ecgSignal`.
 * La señal se genera como una onda sinusoidal con una amplitud máxima ajustada.
 * También se crea un arreglo `timeArray` que contiene los tiempos correspondientes
 * a cada muestra de la señal.
 *
 * @example
 * // Crear una señal ECG con una tasa de muestreo de 1000 Hz
 * createECG(1000);
 */
function createECG(sampleRate) {
    ecgSignal = [];
    timeArray = [];

    const nData = 2000;
    setMaxSliderValues(nData); // Establecer los valores máximos de los deslizadores
    let height = 200;
    let amplitude = height / 2;
    let start = 0
    let timePerSample = 1 / sampleRate;

    let maxAmplitude = amplitude * (0.5 + 0.5 * 0.5);
    for (let i = 0; i < nData; i++) {
        let y = start + maxAmplitude * Math.sin((i / nData) * sampleRate * 2 * Math.PI);
        ecgSignal.push(y);
    }

    timeArray = Array.from({ length: ecgSignal.length }, (_, i) => parseFloat((i * timePerSample).toFixed(2)));
}


/**
 * Detecta picos en una ventana de una señal ECG.
 *
 * @param {number} start - El índice de inicio de la ventana.
 * @param {number} end - El índice de fin de la ventana.
 * @returns {number[]} - Un array con los índices de los picos detectados dentro de la ventana.
 */
function detectPeaksInWindow(start, end) {
    let peaks = [];
    let window = ecgSignal.slice(start, end);
    let peakValues = window.filter((val, i) =>
        i > 0 && i < window.length - 1 && val > window[i - 1] && val > window[i + 1]
    );

    if (peakValues.length > 0) {
        let meanVal = mean(peakValues);
        let stdVal = std(peakValues, meanVal);

        let minThreshold = meanVal + 1 * stdVal;
        let maxThreshold = meanVal + 5 * stdVal;

        for (let i = 1; i < window.length - 1; i++) {
            if (
                window[i] >= minThreshold &&
                window[i] <= maxThreshold &&
                window[i] > window[i - 1] &&
                window[i] > window[i + 1]
            ) {
                peaks.push(start + i);
            }
        }
    }
    return peaks;
}

/**
 * Detecta picos en una señal utilizando una ventana deslizante.
 *
 * @param {number} windowSize - El tamaño de la ventana deslizante.
 * @param {number} step - El paso con el que se moverá la ventana deslizante.
 * @returns {Object} Un objeto que contiene:
 *   - {number[]} allPeaks: Un array con todos los picos detectados.
 *   - {number[]} tacoTimeArray: Un array de tiempos correspondiente a los picos detectados.
 */
function detectPeaksWithSlidingWindow(windowSize, step) {
    let allPeaks = [];

    for (let start = 0; start < ecgSignal.length - windowSize; start += step) {
        let end = start + windowSize;
        let peaks = detectPeaksInWindow(start, end);
        allPeaks.push(...peaks);
    }

    return { allPeaks, tacoTimeArray: timeArray.slice(allPeaks[1]) };
}

/**
 * Calcula la media (promedio) de un array de números.
 *
 * @param {number[]} arr - El array de números.
 * @returns {number} La media de los números en el array.
 */
function mean(arr) {
    return arr.reduce((sum, value) => sum + value, 0) / arr.length;
}

/**
 * Calcula la desviación estándar de un array de números.
 *
 * @param {number[]} arr - El array de números.
 * @param {number} meanVal - la media del array.
 * @returns {number} La desviación estándar del array.
 */
function std(arr, meanVal) {
    let variance = arr.reduce((sum, value) => sum + Math.pow(value - meanVal, 2), 0) / arr.length;
    return Math.sqrt(variance);
}

/**
 * Calcula los intervalos RR dados los picos y un array de tiempos.
 *
 * @param {number[]} peaks - Array de índices de los picos en la señal.
 * @param {number[]} timeArray - Array de tiempos correspondientes a cada muestra de la señal.
 */
function calculateRRIntervals(peaks, timeArray) {
    rrIntervals = [];

    for (let i = 1; i < peaks.length; i++) {
        let rr = timeArray[peaks[i]] - timeArray[peaks[i - 1]];

        // Asegúrate de que el intervalo RR no sea negativo
        if (rr > 0) {
            rrIntervals.push(rr);
        }
    }
}

/**
 * Genera un gráfico de línea de un taquigrama utilizando Highcharts.
 *
 * @param {number[]} rrIntervals - Array de intervalos RR en segundos.
 * @param {string[]} timeArray - Array de tiempos correspondientes en segundos.
 */
function plotTachogram(timeArray) {
    Highcharts.chart('tachogram-container', {
        chart: { type: 'line' },
        title: { text: 'Tachogram' },
        xAxis: { title: { text: 'Time (seconds)' }, categories: timeArray },
        yAxis: { title: { text: 'RR-interval (seconds)' } },
        series: [{ name: 'RR-interval', data: rrIntervals }]
    });
}

/**
 * Actualiza las gráficas de ECG y el taquograma.
 *
 * @param {number} freq - Frecuencia de muestreo de la señal ECG.
 * @param {number} startPoint - Índice inicial de los datos a mostrar.
 * @param {number} windowSize - Tamaño de la ventana de datos a mostrar.
 *
 * @description
 * Esta función actualiza las gráficas de la señal ECG y el taquograma.
 * Primero, crea la señal ECG y luego extrae una ventana de datos de la señal y del tiempo.
 * Utiliza Highcharts para graficar la señal ECG en un contenedor específico.
 * Luego, detecta los picos en la señal ECG utilizando una ventana deslizante y calcula los intervalos RR.
 * Finalmente, grafica el taquograma utilizando los intervalos RR calculados.
 */
function updatePlots(freq, startPoint, windowSize) {
    createECG(freq);
    let signalWindow = ecgSignal.slice(startPoint, startPoint + windowSize);
    let timeWindow = timeArray.slice(startPoint, startPoint + windowSize);

    Highcharts.chart('ecg-container', {
        chart: { type: 'line' },
        title: { text: 'ECG Signal' },
        xAxis: { title: { text: 'Time (seconds)' }, categories: timeWindow },
        yAxis: { title: { text: 'Amplitude' } },
        series: [{ name: 'ECG Signal', data: signalWindow }]
    });
    let data = detectPeaksWithSlidingWindow(windowSize, 10);
    calculateRRIntervals(data.allPeaks, data.tacoTimeArray);
    plotTachogram(data.tacoTimeArray);
}

/**
 * Calcula los latidos por minuto (BPM) basándose en los intervalos RR.
 * Muestra el resultado en el elemento con id 'bpm-result' y un mensaje de alerta
 * en el elemento con id 'alert' dependiendo del rango de BPM calculado.
 * 
 * - Si el BPM es menor a 60, muestra una alerta de posible bradicardia.
 * - Si el BPM es mayor a 100, muestra una alerta de posible taquicardia.
 * - Si el BPM está entre 60 y 100, indica que está dentro del rango normal.
 * - Si no hay suficientes intervalos RR, muestra un mensaje de error.
 * 
 * @function
 */
function calculateBPM() {
    let alertView = document.getElementById('alert');
    let moreInfoButton = document.getElementById('more-info-button'); // Obtén el botón
    if (rrIntervals.length > 0) {
        const avgRRIntervals = rrIntervals.reduce((a, b) => a + b, 0) / rrIntervals.length;
        const bpm = 60 / avgRRIntervals;

        document.getElementById('bpm-result').innerText = bpm.toFixed(2) + " BPM";
        
        // Mostrar botón de "Conocer más sobre mi estado"
        moreInfoButton.style.display = "block"; 

        if (bpm < 60) {
            alertView.innerText = "Alert! possible bradycardia.";
            alertView.style.color = "red";
            alertView.style.fontSize = "30px";
            moreInfoButton.onclick = function() {
                alert("La bradicardia es una condición en la que el corazón late más despacio de lo normal. Puede ser grave en algunos casos y requerir tratamiento.\n" + "\n" + 
                      "Bradicardia leve: 50-60 bpm.\n" +"\n" + 
                      "Bradicardia moderada: 40-50 bpm.\n" +"\n" + 
                      "Bradicardia severa: Menos de 40 bpm.");
            };
        } else if (bpm > 100) {
            alertView.innerText = "Alert! possible tachycardia.";
            alertView.style.color = "red";
            moreInfoButton.onclick = function() {
                alert("La taquicardia es una condición en la que el corazón late más rápido de lo normal. Es importante controlarla, ya que puede derivar en problemas más serios.\n" + "\n" + 
                      "Taquicardia leve: 100-120 bpm.\n" + "\n" + 
                      "Taquicardia moderada: 120-150 bpm.\n" + "\n" + 
                      "Taquicardia grave: Más de 150 bpm.");
            };
        } else {
            alertView.innerText = "Within the normal range.";
            alertView.style.color = "green";
            moreInfoButton.onclick = function() {
                alert("Tu frecuencia cardíaca está dentro de los niveles normales. ¡Sigue así!");
            };
        }
    } else {
        document.getElementById('bpm-result').innerText = "N/A";
        alertView.innerText = "Not enough peaks to calculate BPM.";
        alertView.style.color = "black";
        moreInfoButton.style.display = "none"; // Ocultar botón si no hay BPM calculado
    }
}

function showMoreInfo() {
    // El comportamiento de este botón se ajusta dinámicamente en la función calculateBPM
}

function showPopup() {
    document.getElementById('popup').style.display = 'block'; // Muestra el popup
}

function closePopup() {
    document.getElementById('popup').style.display = 'none'; // Oculta el popup
}

// Cerrar el popup cuando se hace clic fuera del contenido
window.onclick = function(event) {
    const popup = document.getElementById('popup');
    if (event.target === popup) {
        popup.style.display = 'none';
    }
};


// Plotear la señal ECG al cargar la página
document.addEventListener('DOMContentLoaded', updateView);

// Eventos de los sliders
let freqSlider = document.getElementById("freq");
freqSlider.oninput = () => updateView();

let startPointSlider = document.getElementById("start-point");
startPointSlider.oninput = () => updateView();

let windowSizeSlider = document.getElementById("window-size");
windowSizeSlider.oninput = () => updateView();
</script>


</body>

</html>
