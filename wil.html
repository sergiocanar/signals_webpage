<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="style_2.css">
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <style>
        #bpm-container {
            text-align: center;
            margin-top: 20px;
            font-size: 1.2em;
        }

        #ecg-chart {
            margin-top: 40px; 
        }
    </style>
</head>

<body>
    <h1 id="title">ECG Visualization</h1>
    <h2 id="subtitle">Lab 4</h2>
    <figure>
        <img src="https://data.org/wp-content/uploads/2022/02/Universidad-de-los-Andes-975x377.png" 
             alt="Universidad de los Andes" style="width: 10%">
        <figcaption>Departamento de Ingenieria Biomedica</figcaption>
    </figure>

    <label for="frequency">Frecuencia de muestreo (Hz): </label>
    <input type="number" id="frequency" min="1" max="100" value="210">
    <br><br>

    <label for="windowSize">Tamaño de ventana (número de muestras): </label>
    <input type="number" id="windowSize" min="100" max="2000" value="100">
    <br><br>

    <label for="slider">Explorar señal ECG: </label>
    <input type="range" id="slider" min="0" max="0" value="0" step="1" oninput="updateECGPlot()">
    <br><br>

    <button onclick="calculateBPM()">Calcular BPM</button>

    <div id="bpm-container">
        <div id="bpm-result"></div>
        <div id="alert" style="color: red;"></div>
    </div>

    <div id="ecg-chart" style="height: 400px;"></div>

    <script>
        let ecgSignal = [];
        let timeArray = [];

        function createECG(frequency) {
            const number_data = 2000; 
            const height = 200;
            const amplitude = height / 2;
            const sampleRate = frequency; 
            const timePerSample = 1 / sampleRate;

            const maxAmplitude = amplitude * (0.5 + 0.5 * 0.5);
            const signal = [];

            for (let i = 0; i < number_data; i++) {
                let y = maxAmplitude * Math.sin((i / number_data) * sampleRate * 2 * Math.PI);
                signal.push(y);
            }

            const time_array = Array.from({ length: signal.length }, (_, i) => i * timePerSample);
            return { time_array, signal };
        }

        function detectPeaks(signal, windowSize) {
            const peaks = [];
            for (let i = windowSize; i < signal.length - windowSize; i++) {
                let isPeak = true;
                for (let j = 1; j <= windowSize; j++) {
                    if (signal[i] <= signal[i - j] || signal[i] <= signal[i + j]) {
                        isPeak = false;
                        break;
                    }
                }
                if (isPeak) {
                    peaks.push(i);
                }
            }
            return peaks;
        }

        function calculateRRIntervals(peaks, time_array) {
            const rr_intervals = [];
            for (let i = 1; i < peaks.length; i++) {
                const rr = time_array[peaks[i]] - time_array[peaks[i - 1]];
                if (rr > 0) {
                    rr_intervals.push(rr);
                }
            }
            return rr_intervals;
        }

        function calculateBPM() {
            document.getElementById('bpm-result').innerText = "";
            document.getElementById('alert').innerText = "";

            const frequency = parseInt(document.getElementById('frequency').value);
            const windowSize = parseInt(document.getElementById('windowSize').value);

            if (isNaN(frequency) || isNaN(windowSize) || frequency <= 0 || windowSize <= 0) {
                alert("Por favor ingrese valores válidos para la frecuencia y el tamaño de la ventana.");
                return;
            }

            const data = createECG(frequency);
            ecgSignal = data.signal;
            timeArray = data.time_array;

            const peaks = detectPeaks(ecgSignal, windowSize);
            const rr_intervals = calculateRRIntervals(peaks, timeArray);

            const slider = document.getElementById('slider');
            slider.max = ecgSignal.length - windowSize;

            updateECGPlot();

            if (rr_intervals.length > 0) {
                const avg_rr_interval = rr_intervals.reduce((a, b) => a + b, 0) / rr_intervals.length;
                const bpm = 60 / avg_rr_interval;

                document.getElementById('bpm-result').innerText = "Tus latidos por minuto son: " + bpm.toFixed(2);

                if (bpm < 60) {
                    document.getElementById('alert').innerText = "Cuidado, posible bradicardia.";
                } else if (bpm > 100) {
                    document.getElementById('alert').innerText = "Cuidado, posible taquicardia.";
                } else {
                    document.getElementById('alert').innerText = "Estás dentro del rango normal.";
                }
            } else {
                document.getElementById('alert').innerText = "No se encontraron suficientes picos para calcular los BPM.";
            }
        }

        function updateECGPlot() {
            const windowSize = parseInt(document.getElementById('windowSize').value);
            const sliderValue = parseInt(document.getElementById('slider').value);

            const signalWindow = ecgSignal.slice(sliderValue, sliderValue + windowSize);
            const timeWindow = timeArray.slice(sliderValue, sliderValue + windowSize);

            Highcharts.chart('ecg-chart', {
                chart: {
                    type: 'line'
                },
                title: {
                    text: 'Electrocardiograma'
                },
                xAxis: {
                    categories: timeWindow
                },
                yAxis: {
                    title: {
                        text: 'Amplitud'
                    }
                },
                series: [{
                    name: 'ECG Signal',
                    data: signalWindow
                }]
            });
        }
    </script>

    <footer id="footer">
        <p>Authors: Sergio Andres Canar Lozano (202020383) and David Tobon Molina (202123804)</p>
        <p>GitHub Profiles: <a href="https://github.com/sergiocanar">sergiocanar</a> and 
           <a href="https://github.com/DavidTobonIBIO">DavidTobonIBIO</a></p>
        <p>Source code: <a href="https://github.com/sergiocanar/singnals_webpage">
            https://github.com/sergiocanar/singnals_webpage</a></p>
    </footer>
</body>

</html>
