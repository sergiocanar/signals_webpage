<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width"> 
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="style_main.css"> 
    <script src="https://code.highcharts.com/highcharts.js"></script>
</head>

<body> 
    <h1 id="title">ECG Visualization</h1>
    <h2 id="subtitle">Lab 4</h2>
    <figure>
        <img src="https://data.org/wp-content/uploads/2022/02/Universidad-de-los-Andes-975x377.png" alt="Universidad de los Andes" style="width: 10%">
        <figcaption>Departamento de Ingenieria Biomedica</figcaption>

    </figure>

    <label for="value1">Frequency: </label>
    <input type="range" id="value1" min="0" max="100" value="0" step="1" oninput="updateValue(this.value)">
    <span id="value1Display">0 Hz</span>

    <div id="ecg-container" style="width: 100%; height: 400px;"></div>

    <script>
        function updateValue(val) {
            document.getElementById('value1Display').innerText = val + " Hz";
        }
        
        // Function to create an artificial ECG signal with randomized frequency and amplitude
        function createECG() {
            const width = 500; // Width of the canvas or the number of points in the signal
            const height = 200; // Height of the canvas
            
            const amplitude = height / 2; // Set amplitude relative to the canvas height
            const sampleRate = parseInt(document.getElementById('value1').value); // Get value from the range input (Hz)
                    
            const timePerSample = 1 / sampleRate; // Time duration of each sample in seconds
            
            // Parameters for the sinusoidal signal
            const maxAmplitude = amplitude * (0.5 + Math.random() * 0.5); // Random amplitude between 0.5 and 1 times the max height
            const waveFrequency = 0.5 + Math.random() * 2; // Random frequency between 0.5 and 2 Hz
        
            const time_array = [];
            const signal = []; 
        
            for (let i = 0; i < width; i++) {
                let t = i * timePerSample; // Time in seconds for the current sample
                let y = maxAmplitude * Math.sin(2 * Math.PI * waveFrequency * t); // Sinusoidal wave formula
                time_array.push(t); // Add the time to the time array
                signal.push(y); // Add the value to the signal array
            }
        
            return { time_array, signal };
        }
        

        // Function to plot ECG signal using Highcharts
        function plotECG() {
            const data = createECG(); // Get ECG signal data

            if (data.signal.length > 0) {
                Highcharts.chart('ecg-container', {
                    chart: {
                        type: 'line'
                    },
                    title: {
                        text: 'ECG Signal Plot'
                    },
                    xAxis: {
                        title: {
                            text: 'Time (seconds)'
                        },
                        categories: data.time_array // Time values for the x-axis
                    },
                    yAxis: {
                        title: {
                            text: 'Amplitude'
                        }
                    },
                    series: [{
                        name: 'ECG Signal',
                        data: data.signal // Amplitude values for the y-axis
                    }]
                });
            }
        }
                // Detect peaks to calculate RR intervals for the tachogram
                function detectPeaks(signal) {
            const peaks = [];
            const threshold = Math.max(...signal) * 0.7; // Threshold, 70% of the max amplitude

            for (let i = 1; i < signal.length - 1; i++) {
                if (signal[i] > threshold && signal[i] > signal[i - 1] && signal[i] > signal[i + 1]) {
                    peaks.push(i); // Store the index of the peak
                }
            }

            return peaks;
        }

        // Calculate RR intervals (in seconds)
        function calculateRRIntervals(peaks, time_array) {
            const rr_intervals = [];

            for (let i = 1; i < peaks.length; i++) {
                const rr = time_array[peaks[i]] - time_array[peaks[i - 1]]; // Calculate RR interval
                rr_intervals.push(rr);
            }

            return rr_intervals;
        }

        // Function to plot the ECG signal using Highcharts
        function plotECG() {
            const data = createECG();

            Highcharts.chart('ecg-container', {
                chart: { type: 'line' },
                title: { text: 'ECG Signal Plot' },
                xAxis: { title: { text: 'Time (seconds)' }, categories: data.time_array },
                yAxis: { title: { text: 'Amplitude' } },
                series: [{ name: 'ECG Signal', data: data.signal }]
            });

            const peaks = detectPeaks(data.signal);
            const rr_intervals = calculateRRIntervals(peaks, data.time_array);

            plotTachogram(rr_intervals);
        }

        // Function to plot the tachogram (RR intervals)
        function plotTachogram(rr_intervals) {
            Highcharts.chart('tachogram-container', {
                chart: { type: 'line' },
                title: { text: 'Tachogram (RR Intervals)' },
                xAxis: { title: { text: 'Beat Number' }, categories: rr_intervals.map((_, i) => i + 1) },
                yAxis: { title: { text: 'RR Interval (seconds)' } },
                series: [{ name: 'RR Interval', data: rr_intervals }]
            });
        }

        // Re-plot the signal whenever the slider is moved
        document.getElementById('value1').addEventListener('input', plotECG);

        // Automatically update the ECG signal every 1 second (1000 milliseconds)
        setInterval(plotECG, 10000); // Change the interval time as needed (in milliseconds)
    </script>

</body>

<footer id="footer">
    <p>Authors: Sergio Andres Canar Lozano (202020383) and David Tobon Molina (202123804)</p>
    <p>GitHub Profiles: <a href="https://github.com/sergiocanar">sergiocanar</a> and <a href="https://github.com/DavidTobonIBIO"> DavidTobonIBIO</a></p>
    <p>Source code: <a href="https://github.com/sergiocanar/singnals_webpage">https://github.com/sergiocanar/singnals_webpage</a></p>
</footer>

</html>
