<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="icon" href="https://github.com/sergiocanar/signals_webpage/blob/main/images/favicon.ico">
    <style>
/* General */
html, body {
    height: 100%;  /* Ensure full height of the viewport */
    margin: 0;
    padding: 0;
    background-color: #F9F5FF;
    font-family: Arial, sans-serif;
    text-align: center; /* Center all text horizontally */
    display: flex;
    flex-direction: column;
}

.container {
    flex: 1; /* This allows the container to grow and fill the available space */
    padding-bottom: 60px; /* Adjust this to match the footer height */
}

/* Header */
header {
    background-color: #28262C;
    color: #F9F5FF;
    padding: 20px 0;
}

/* Sections */
section {
    padding: 20px;
    margin: 20px;
    background-color: #F9F5FF;
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

h1 {
    margin: 0;
    font-size: 2em;
    color: #28262C;
}

h2 {
    margin: 0;
    font-size: 1.5em;
    color: #28262C;
}


/* Button */
#more-info-button {
    padding: 10px 20px;
    font-size: 1em;
    color: #f7f7f7;
    background-color: #28262C;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 20px;
    display:none;
    margin: auto;
}

#more-info-button:hover {
    background-color: #14248A;
}

/* List */
ul {
    list-style-type: none;
    padding: 0;
}

li {
    margin: 10px 0;
    font-size: 16px;
}

/* Footer */
#footer {
    position: fixed; /* Keep footer fixed at the bottom */
    bottom: 0;
    width: 100%; /* Full width */
    background-color: #28262C;
    color: white;
    padding: 10px;
    text-align: center;
    z-index: 10; /* Make sure it's above other content */
    overflow-y: auto; /* Enable scrolling if content exceeds the height */
}

a {
    color: #d7db1c;
}

a:link, a:visited {
    color: #d4c2fc;
    text-decoration: none;
}

#ecg-container {
    width: 100%; 
    height: 400px;
}

#tachogran-container {
    width: 100%;
    height: 400px;
    margin-top: 20px;
}


#freq {
    width: 10%;
    margin: 0 auto;
}
</style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://code.highcharts.com/highcharts.js"></script>
</head>

<body>
    <div class="container">
        <div class="row">
            <h1 id="title">ECG Visualization</h1>
            <h2 id="subtitle">Lab 4</h2>
            <figure>
                <img class="img-fluid" src="https://data.org/wp-content/uploads/2022/02/Universidad-de-los-Andes-650x251.png" 
                alt="Universidad de los Andes" style="width: 10%">
                <figcaption>Departamento de Ingenieria Biomedica</figcaption>
                <hr>
            </figure>
        </div>
        <div class="row">
            <div class="col-6">
                <div>
                    <label for="freq">Frequency: </label>
                    <input type="range" id="freq" min="0" max="100" value="10" step="5">
                    <span id="freq-display">10 Hz</span>
                </div>
                <div>
                    <label for="start-point">Explore ECG: </label>
                    <input type="range" id="start-point" min="0" value="0" step="1">
                    <span id="start-point-display">0</span>
                </div>
                <div>
                    <label for="window-size">Window size (number of data): </label>
                    <input type="range" id="window-size" min="100" value="1" step="1">
                    <span id="window-size-display">100</span>
                </div>
            </div>
            <div class="col-6">
                <div id="bpm-container">
                    <h3 id="bpm-result"></h3>
                    <h3 id="alert"></h3>
                    <button id="more-info-button" class="btn btn-primary">Conocer mÃ¡s sobre mi estado</button>
                    <div style="height: 50px;"></div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div id="ecg-container"></div>
        </div>
        <div class="row">
            <div id="tachogram-container"></div>
        </div>
    </div>
    
    <footer id="footer">
        <p>Authors: <a href="https://github.com/sergiocanar">Sergio Andres Canar Lozano</a> (202020383) and <a href="https://github.com/DavidTobonIBIO">David Tobon Molina</a> (202123804)</p>
        <p>Source code: <a href="https://github.com/sergiocanar/signals_webpage">
            https://github.com/sergiocanar/signals_webpage</a></p>
    </footer>
    <script>

let ecgSignal = [];
let timeArray = [];
let rrIntervals = [];


function updateView() {
    
    let freqVal = parseInt(document.getElementById('freq').value);
    let startPointVal = parseInt(document.getElementById('start-point').value);
    let windowSizeVal = parseInt(document.getElementById('window-size').value);
    
    document.getElementById('freq-display').innerText = freqVal + " Hz";
    document.getElementById('start-point-display').innerText = startPointVal;
    document.getElementById('window-size-display').innerText = windowSizeVal;
    
    updatePlots(freqVal, startPointVal, windowSizeVal);  
    
    calculateBPM();
}


function setMaxSliderValues(nData) {
    document.getElementById('start-point').max = nData;
    document.getElementById('window-size').max = nData;
}


function createECG(sampleRate) {
    ecgSignal = [];
    timeArray = [];

    const nData = 2000;
    setMaxSliderValues(nData); 
    let height = 200;
    let amplitude = height / 2;
    let start = 0;
    let timePerSample = 1 / sampleRate;

    let maxAmplitude = amplitude * (0.5 + 0.5 * 0.5);
    for (let i = 0; i < nData; i++) {
        let y = start + maxAmplitude * Math.sin((i / nData) * sampleRate * 2 * Math.PI);
        ecgSignal.push(y);
    }

    timeArray = Array.from({ length: ecgSignal.length }, (_, i) => parseFloat((i * timePerSample).toFixed(2)));
}



function detectPeaksInWindow(start, end) {
    let peaks = [];
    let window = ecgSignal.slice(start, end);
    let peakValues = window.filter((val, i) =>
        i > 0 && i < window.length - 1 && val > window[i - 1] && val > window[i + 1]
    );

    if (peakValues.length > 0) {
        let meanVal = mean(peakValues);
        let stdVal = std(peakValues, meanVal);

        let minThreshold = meanVal + 1 * stdVal;
        let maxThreshold = meanVal + 5 * stdVal;

        for (let i = 1; i < window.length - 1; i++) {
            if (
                window[i] >= minThreshold &&
                window[i] <= maxThreshold &&
                window[i] > window[i - 1] &&
                window[i] > window[i + 1]
            ) {
                peaks.push(start + i);
            }
        }
    }
    return peaks;
}


function detectPeaksWithSlidingWindow(windowSize, step) {
    let allPeaks = [];

    for (let start = 0; start < ecgSignal.length - windowSize; start += step) {
        let end = start + windowSize;
        let peaks = detectPeaksInWindow(start, end);
        allPeaks.push(...peaks);
    }

    return { allPeaks, tacoTimeArray: timeArray.slice(allPeaks[1]) };
}


function mean(arr) {
    return arr.reduce((sum, value) => sum + value, 0) / arr.length;
}


function std(arr, meanVal) {
    let variance = arr.reduce((sum, value) => sum + Math.pow(value - meanVal, 2), 0) / arr.length;
    return Math.sqrt(variance);
}


function calculateRRIntervals(peaks, timeArray) {
    rrIntervals = [];

    for (let i = 1; i < peaks.length; i++) {
        let rr = timeArray[peaks[i]] - timeArray[peaks[i - 1]];

        
        if (rr > 0) {
            rrIntervals.push(rr);
        }
    }
}


function plotTachogram(timeArray) {
    Highcharts.chart('tachogram-container', {
        chart: { type: 'line' },
        title: { text: 'Tachogram' },
        xAxis: { title: { text: 'Time (seconds)' }, categories: timeArray },
        yAxis: { title: { text: 'RR-interval (seconds)' } },
        series: [{ name: 'RR-interval', data: rrIntervals }]
    });
}


function updatePlots(freq, startPoint, windowSize) {
    createECG(freq);
    let signalWindow = ecgSignal.slice(startPoint, startPoint + windowSize);
    let timeWindow = timeArray.slice(startPoint, startPoint + windowSize);

    Highcharts.chart('ecg-container', {
        chart: { type: 'line' },
        title: { text: 'ECG Signal' },
        xAxis: { title: { text: 'Time (seconds)' }, categories: timeWindow },
        yAxis: { title: { text: 'Amplitude' } },
        series: [{ name: 'ECG Signal', data: signalWindow }]
    });
    let data = detectPeaksWithSlidingWindow(windowSize, 10);
    calculateRRIntervals(data.allPeaks, data.tacoTimeArray);
    plotTachogram(data.tacoTimeArray);
}


function calculateBPM() {
    let alertView = document.getElementById('alert');
    let moreInfoButton = document.getElementById('more-info-button');
    if (rrIntervals.length > 0) {
        const avgRRIntervals = rrIntervals.reduce((a, b) => a + b, 0) / rrIntervals.length;
        const bpm = 60 / avgRRIntervals;

        document.getElementById('bpm-result').innerText = bpm.toFixed(2) + " BPM";
        
        moreInfoButton.style.display = "block"; 

        if (bpm < 60) {
            alertView.innerText = "Alert! possible bradycardia.";
            alertView.style.color = "red";
            moreInfoButton.onclick = () => {
                alert(`Bradycardia is a condition where the heart beats slower than normal. It can be serious in some cases and may require treatment.

                    Mild bradycardia: 50-60 bpm.

                    Moderate bradycardia: 40-50 bpm.

                    Severe bradycardia: Less than 40 bpm.`);
            };
        } else if (bpm > 100) {
            alertView.innerText = "Alert! possible tachycardia.";
            alertView.style.color = "red";
            moreInfoButton.onclick = () => {
                alert(`Tachycardia is a condition where the heart beats faster than normal. It is important to monitor it as it can lead to more serious problems.

                    Mild tachycardia: 100-120 bpm.

                    Moderate tachycardia: 120-150 bpm.

                    Severe tachycardia: More than 150 bpm.`);
            };
        } else {
            alertView.innerText = "Within the normal range.";
            alertView.style.color = "green";
            moreInfoButton.onclick = () => {
                alert("Tu frecuencia cardíaca está dentro de los niveles normales. ¡Sigue así!");
            };
        }
    } else {
        document.getElementById('bpm-result').innerText = "N/A";
        alertView.innerText = "Not enough peaks to calculate BPM.";
        alertView.style.color = "black";
        moreInfoButton.style.display = "none"; 
    }
}



document.addEventListener('DOMContentLoaded', updateView);


let freqSlider = document.getElementById("freq");
freqSlider.oninput = () => updateView();

let startPointSlider = document.getElementById("start-point");
startPointSlider.oninput = () => updateView();

let windowSizeSlider = document.getElementById("window-size");
windowSizeSlider.oninput = () => updateView();
</script>
</body>

</html>
